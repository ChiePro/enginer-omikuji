# Implementation Plan

**重要なルール**: タスク完了時は必ずこのtasks.mdファイルで該当するチェックボックスを `- [x]` に更新すること

- [ ] 1. おみくじ結果データモデルと基盤実装

おみくじ結果を表現するドメインモデルとデータアクセス基盤を構築する。各おみくじタイプ・運勢の組み合わせに対して複数の結果バリエーションを管理できる仕組みを実装。

- [x] 1.1 ドメインモデル実装
- OmikujiResult エンティティクラスを実装（タイトルフレーズ、説明、感情属性、5項目カテゴリを含む）
- TitlePhrase 値オブジェクトを実装（20-40文字制限、目を引く表現の検証ロジック付き）
- Description 値オブジェクトを実装（100-300文字制限の検証付き）
- FortuneCategory、FortuneCategoryCollection 値オブジェクトを実装（5項目必須性と一貫性検証）
- EmotionAttribute 列挙型を定義（positive、neutral、negative）
- 各モデルの単体テストを作成

_Requirements: 1, 3_

- [x] 1.2 (P) 結果データリポジトリ実装
- IOmikujiResultRepository インターフェースを定義
- JsonOmikujiResultRepository クラスを実装（JSONファイルベースのデータアクセス）
- おみくじタイプごとの独立JSONファイル読み込み機能を実装
- 運勢・感情属性によるフィルタリング機能を実装
- デフォルト結果の生成機能を実装
- リポジトリの統合テストを作成

_Requirements: 1, 2, 6_

- [x] 1.3 (P) 感情属性確率分布システム実装
- EmotionAttributeDistribution 値オブジェクトを実装（確率合計1.0の検証付き）
- EmotionAttributeCalculator サービスを実装（運勢レベルに応じた確率計算）
- 確率分布の定義データ構造を設計・実装
- 10,000回イテレーションによる統計的検証テストを作成

_Requirements: 2, 3, 5_

- [ ] 2. おみくじ抽選ビジネスロジック実装

既存の運勢抽選システムを拡張し、感情属性に基づく結果選択ロジックを統合。お賽銭レベルによる確率調整機能も実装。

- [x] 2.1 OmikujiDrawService 実装
- 既存FortuneRepositoryとの統合実装
- 運勢抽選後の結果選択ロジックを実装
- お賽銭レベルによる確率調整機能を追加
- エラー時のフォールバック処理を実装
- DrawError型の定義と適切なエラーハンドリング
- サービスの単体テストとBDDシナリオテストを作成

_Requirements: 2, 3, 6_

- [x] 2.2 (P) 抽選API統合
- /api/omikuji/draw エンドポイントを実装（既存APIの拡張）
- リクエスト・レスポンス型定義の実装
- エラーレスポンスの統一化
- API統合テストの作成

_Requirements: 2, 6_

- [ ] 3. 日本式縦書きUI実装

伝統的なおみくじの視覚体験を再現する縦書きレイアウトシステムとアニメーション演出を実装。

- [x] 3.1 TraditionalLayoutEngine 実装
- CSS writing-modeを活用した縦書きスタイル生成エンジンを実装
- 運勢レベルに応じた色彩・装飾の定義
- ブラウザ互換性チェックとフォールバック処理
- レイアウトエンジンの単体テストを作成

_Requirements: 4_

- [x] 3.2 OmikujiResultDisplay コンポーネント実装
- 日本式縦書き結果表示Reactコンポーネントを実装
- Framer Motionによるおみくじ開封アニメーション演出
- レスポンシブ対応（モバイル・デスクトップ）
- アクセシビリティ対応（キーボード操作、スクリーンリーダー）
- コンポーネントの表示テストを作成

_Requirements: 4_

- [x] 3.3 (P) 既存UIとの統合
- OmikujiCard コンポーネントから結果表示への遷移実装
- 結果表示後の再抽選フローの実装
- 既存のSmoothTransitionsアニメーションとの統合
- E2Eテストによる完全フローの検証

_Requirements: 4, 6_

- [ ] 4. エンジニア特化コンテンツ作成

エンジニア文化に根ざした魅力的で実用的なおみくじ結果コンテンツを作成。各運勢レベルに多様なバリエーションを用意。

- [x] 4.1 結果コンテンツ設計・作成
- 各おみくじタイプ・運勢組み合わせに最低3つの結果バリエーションを作成（※バリエーション追加はタスク6.1に持ち越し）
- エンジニア特有の表現を含むタイトルフレーズの作成（実装済み）
- 5項目（恋愛運、仕事運、健康運、金運、学業運）の具体的内容作成（実装済み）
- 感情属性（ポジティブ・ネガティブ・ニュートラル）の適切な設定（実装済み）

_Requirements: 3, 5_

- [x] 4.2 結果データJSONファイル作成
- data/results/ディレクトリ構造の作成
- 各おみくじタイプごとのJSONファイル作成
- メタデータ（バージョン、更新日時、感情分布ルール）の定義
- データ検証スクリプトの作成

_Requirements: 1, 5_

- [ ] 5. システム統合とテスト

全コンポーネントを統合し、エンドツーエンドでの動作検証と品質保証を実施。

- [x] 5.1 統合テスト実装
- おみくじ選択→抽選→結果表示の完全フローテスト
- 全おみくじタイプ・運勢組み合わせの網羅的テスト
- エラーケースとフォールバック動作の検証
- パフォーマンステスト（1000回連続抽選）

_Requirements: 1, 2, 3, 4, 5, 6_

- [x] 5.2 (P) 最終調整と文書化
- TypeScript型定義の整理と export
- 既存システムとの互換性確認
- 開発者向けドキュメントの作成
- コードレビューと品質改善

_Requirements: 6_

- [ ] 6. 結果コンテンツの拡充と改善

現在の警告レベルの課題を解決し、より充実したコンテンツを作成。

- [x] 6.1 結果バリエーションの追加（タスク4.1から持ち越し）
- 各運勢タイプに最低3つ以上のバリエーションを追加
- 特にchukichi、shokichi、kyo、daikyoの不足分を補充（完了: debug-fortune, code-review-fortune, deploy-fortune）
- 各おみくじタイプのバリエーション増加（完了: engineer-fortune, tech-selection, debug-fortune, code-review-fortune, deploy-fortune）
- 既存のemotionDistributionRulesに従った感情属性の適切な配分（実装済み）

_Requirements: 3, 5_

- [x] 6.2 エンジニア特化表現の充実
- より多様な技術用語・エンジニア文化を反映した表現の追加
- 各カテゴリ（恋愛運、仕事運、健康運、金運、学業運）にエンジニア特有のシチュエーションを反映
- 最新の技術トレンドや開発文化を取り入れた内容の作成
- データ検証スクリプトでの警告解消の確認

_Requirements: 3, 5_

## 次のアクション

タスクを確認し、準備ができたら以下のコマンドで実装を開始できます：
- 特定タスクの実装: /kiro:spec-impl omikuji-results 1.1
- 複数タスクの実装: /kiro:spec-impl omikuji-results 1.1,1.2
