# Implementation Plan

## Overview
本実装計画は、運勢種類システムの構築に必要なタスクを定義する。7段階の運勢レベル（大吉、吉、中吉、小吉、末吉、凶、大凶）とメッセージシステムを実装し、重み付き確率分布によるランダム選択機能を提供する。

## Task List

### データ層の実装

- [ ] 1. 運勢レベルとメッセージのデータ定義
- [x] 1.1 (P) 運勢レベルの型定義とマスターデータを作成する
  - 7段階の運勢レベル（大吉、吉、中吉、小吉、末吉、凶、大凶）を型安全に定義する
  - 各運勢レベルにID、表示名、重み（確率）、ランク（順序）を持たせる
  - イミュータブルなreadonly配列として実装し、型推論を最大化する
  - 重みの合計が100になるように設定する（例：大吉=20, 吉=25, 中吉=25, 小吉=15, 末吉=10, 凶=4, 大凶=1）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 3.1, 3.3, 5.5, 5.7, 6.1, 6.3, 7.1_

- [x] 1.2 (P) 運勢メッセージのマスターデータを作成する
  - 4種類のおみくじ×7段階の運勢=28パターンのメッセージを定義する
  - 各メッセージにおみくじID、運勢ID、メッセージ本文を持たせる
  - メッセージはエンジニアの業務に関連した表現を含む
  - 運勢レベルに応じた適切なトーン（大吉は励まし、凶は注意喚起）でメッセージを作成する
  - 各メッセージは100文字程度の読みやすい長さにする
  - イミュータブルなreadonly配列として実装する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 6.1, 6.3, 7.1_

### ロジック層の実装

- [ ] 2. 運勢ランダム選択機能の実装
- [x] 2.1 重み付き確率分布によるランダム選択ロジックを実装する
  - 運勢レベルの重みに基づいた累積確率配列を生成する
  - JavaScriptの標準乱数生成を使用してランダムに運勢を選択する
  - 大吉・吉・中吉が高確率、小吉・末吉が通常確率、凶・大凶が低確率で選ばれるようにする
  - 純粋関数として実装し、副作用なし、テスト可能性を確保する
  - 選択された運勢レベルを返す関数を提供する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.6, 6.1, 7.1_

- [x] 2.2 運勢メッセージ取得機能を実装する（2.1に依存）
  - おみくじIDと運勢IDの組み合わせからメッセージを取得する
  - メッセージが見つからない場合は明確なエラーをスローする
  - 線形探索で実装する（データ量が28件と少ないため十分）
  - _Requirements: 2.2, 3.2, 6.1_

- [x] 2.3 運勢抽選結果を返す統合関数を実装する（2.1, 2.2に依存）
  - おみくじIDを受け取り、運勢レベルとメッセージを含む結果オブジェクトを返す
  - 不正なおみくじIDに対してはエラーハンドリングを実施する
  - 既存のOmikuji型定義と統合可能な設計とする
  - _Requirements: 2.2, 3.2, 5.1, 6.1, 6.5_

### テスト実装

- [ ] 3. データ層のテスト
- [x] 3.1 (P) 運勢レベルデータの妥当性テストを実装する
  - 運勢レベル配列が7要素を持つことを検証する
  - 各運勢レベルが必須フィールド（id, name, weight, rank）を持つことを検証する
  - 重みの合計が100であることを検証する
  - ランクが1から7まで重複なく存在することを検証する
  - _Requirements: 1.1, 1.2, 1.3, 1.4_
  - _実装済み: lib/__tests__/fortune-data.test.ts (タスク1.1で実装)_

- [x] 3.2 (P) 運勢メッセージデータの妥当性テストを実装する
  - メッセージ配列が28要素（4おみくじ×7運勢）を持つことを検証する
  - 全てのおみくじIDと運勢IDの組み合わせに対してメッセージが存在することを検証する
  - メッセージの長さが適切な範囲（概ね100文字前後）であることを検証する
  - _Requirements: 2.1, 2.5_
  - _実装済み: lib/__tests__/fortune-messages.test.ts (タスク1.2で実装)_

- [ ] 4. ロジック層のテスト
- [x] 4.1 ランダム選択ロジックの基本動作テストを実装する
  - 有効なおみくじIDに対して運勢結果が返されることを検証する
  - 不正なおみくじIDに対してエラーがスローされることを検証する
  - 返される運勢レベルが7種類のいずれかであることを検証する
  - _Requirements: 5.1, 6.1_
  - _実装済み: lib/__tests__/fortune-selector.test.ts (タスク2.1で実装), lib/__tests__/draw-fortune.test.ts (タスク2.3で実装)_

- [x] 4.2 確率分布の統計的検証テストを実装する
  - 10,000回の抽選を実行し、各運勢の出現率を測定する
  - 各運勢の出現率が設定された重みに近いことを検証する（許容誤差±7%）
  - 大吉・吉・中吉の合計出現率が73%前後であることを検証する（許容誤差±10%）
  - 凶・大凶の合計出現率が7%前後であることを検証する（許容誤差±5%）
  - _Requirements: 5.2, 5.3, 5.4, 5.5, 5.6_
  - _実装済み: lib/__tests__/fortune-selector.test.ts (タスク2.1で実装)_

- [x] 4.3 メッセージ取得機能のテストを実装する
  - 有効なおみくじIDと運勢IDの組み合わせで正しいメッセージが返されることを検証する
  - 存在しない組み合わせに対してエラーがスローされることを検証する
  - 既存のOmikuji型定義との統合が正しく動作することを検証する
  - _Requirements: 2.2, 3.2, 6.5_
  - _実装済み: lib/__tests__/fortune-message-getter.test.ts (タスク2.2で実装), lib/__tests__/draw-fortune.test.ts (タスク2.3で実装)_

### 統合と検証

- [ ] 5. 既存システムとの統合検証
- [x] 5.1 既存のOmikuji型との統合テストを実装する
  - 既存のomikujiListの全てのIDに対して運勢抽選が成功することを検証する
  - 全28パターン（4おみくじ×7運勢）のメッセージが取得可能であることを検証する
  - 不正なおみくじIDに対して適切にエラーハンドリングされることを検証する
  - _Requirements: 6.5_
  - _実装済み: lib/__tests__/integration.test.ts (9テスト)_

- [x] 5.2 パフォーマンステストを実装する
  - 運勢選択処理が1ms以下で完了することを検証する
  - メッセージ取得処理が0.5ms以下で完了することを検証する
  - 1,000回連続呼び出しでメモリリークがないことを検証する
  - _Requirements: 7.1_
  - _実装済み: lib/__tests__/performance.test.ts (7テスト)_

- [x] 5.3 型安全性とコード品質の最終確認を実施する
  - TypeScript strict modeでエラーがないことを確認する
  - ESLint (eslint-config-next) でwarningがないことを確認する
  - 全てのテストがパスすることを確認する
  - _Requirements: 6.1, 6.4_
  - _確認済み: 全88テストがパス、TypeScript strict mode ✓、ESLint ✓_

## Requirements Coverage

全ての要件がタスクにマッピングされていることを確認：

- **Requirement 1** (運勢タイプの定義): タスク 1.1, 3.1
- **Requirement 2** (運勢メッセージの定義): タスク 1.2, 2.2, 2.3, 3.2, 4.3
- **Requirement 3** (データ構造): タスク 1.1, 1.2, 2.2, 2.3, 4.3
- **Requirement 4** (運勢の表示): UI実装（別specで対応、本specでは範囲外）
- **Requirement 5** (ランダム運勢選択と確率分布): タスク 1.1, 2.1, 2.3, 4.1, 4.2
- **Requirement 6** (技術的制約): タスク 1.1, 1.2, 2.1, 2.2, 2.3, 4.1, 4.3, 5.1, 5.3
- **Requirement 7** (パフォーマンスとアクセシビリティ): タスク 1.1, 1.2, 2.1, 5.2

**注**: Requirement 4（運勢の表示）はUI実装に関する要件であり、本specではデータ層とロジック層のみを実装するため、別specで対応する。

## Task Dependencies

```
1.1 (P) ──┐
          ├──> 2.1 ──> 2.2 ──> 2.3 ──> 5.1
1.2 (P) ──┘                              │
                                         ├──> 5.2 ──> 5.3
3.1 (P), 3.2 (P), 4.1, 4.2, 4.3 ────────┘
```

**並列実行可能なタスク**:
- 1.1, 1.2: データ定義は独立して実施可能
- 3.1, 3.2: データ層のテストはそれぞれ独立

**依存関係のあるタスク**:
- 2.1 → 2.2 → 2.3: ロジック層は順次実装が必要
- 5.1, 5.2, 5.3: 統合テストは全ての実装とテストが完了後に実施
