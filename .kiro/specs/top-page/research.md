# トップページ設計調査記録

## 概要

### 調査範囲
トップページの技術設計において、Next.js 16のパフォーマンス最適化、Framer Motionによるアニメーション実装、WCAGアクセシビリティ要件への準拠について包括的な調査を実施した。

### 主要な発見事項
1. **Next.js 16のServer Components First Approach**が最適なパフォーマンスを実現
2. **Framer Motionの最新API**でハードウェアアクセラレーションを活用可能
3. **96.8%のWebサイトがWCAG非準拠**という現状を踏まえ、アクセシビリティを最初から考慮した設計が重要

## 調査ログ

### 1. Next.js 16パフォーマンス最適化

#### 調査内容
Next.js 16 App Routerにおけるランディングページのベストプラクティスを調査。

#### 情報源
- Next.js公式ドキュメント
- Vercelのディスカッションフォーラム
- 開発コミュニティの実践事例

#### 重要な発見
1. **Server Components First**
   - デフォルトでServer Componentとして実装
   - クライアントへのJavaScript配信を最小化
   - "use client"ディレクティブは必要な場所のみ

2. **Turbopack統合**
   - 開発時のパフォーマンスが大幅に改善
   - `next dev --turbo`で高速な開発体験

3. **画像最適化**
   - `next/image`コンポーネントで自動最適化
   - レイジーローディング
   - デバイスサイズに応じた自動リサイズ

#### 設計への影響
- トップページのメインコンポーネントはServer Componentとして実装
- インタラクティブな要素（カードホバー等）のみClient Component化

### 2. Framer Motionアニメーション戦略

#### 調査内容
Next.js 16環境でのFramer Motionの最適な実装パターンを調査。

#### 情報源
- Motion公式ドキュメント（2024年最新版）
- 実装事例とパフォーマンスベンチマーク

#### 重要な発見
1. **パフォーマンス最適化**
   - ハードウェアアクセラレーション対応
   - React renderをトリガーしない直接DOM更新
   - CSS変数よりMotionValuesが高パフォーマンス

2. **実装パターン**
   - `AnimatePresence`でページ遷移アニメーション
   - `whileInView`でスクロール連動アニメーション
   - `variants`で再利用可能なアニメーション定義

3. **App Router対応**
   - Client Componentでのみ使用（"use client"必須）
   - レイアウトアニメーションの制約に注意

#### 設計への影響
- アニメーションは専用のClient Componentに分離
- 控えめなアニメーションで UXを向上

### 3. アクセシビリティ要件（WCAG 2.1/2.2）

#### 調査内容
WCAG 2.1 Level AA準拠のための具体的な実装要件を調査。

#### 情報源
- W3C WCAG 2.1/2.2公式ガイドライン
- WebAIMのアクセシビリティ統計
- 実装ベストプラクティス

#### 重要な発見
1. **キーボードナビゲーション**
   - 全インタラクティブ要素はキーボード操作可能
   - フォーカス順序は論理的
   - キーボードトラップの回避

2. **スクリーンリーダー対応**
   - セマンティックHTML使用
   - 適切なARIAラベル
   - alt属性の必須化

3. **新基準（WCAG 2.2）**
   - Focus Visible（AA）：フォーカス表示必須
   - Focus Not Obscured：フォーカス要素の非隠蔽

#### 設計への影響
- セマンティックHTMLを基本とした構造設計
- カスタムフォーカス表示の実装
- 色だけに依存しない情報伝達

### 4. BDDによるドメインモデル駆動テスト

#### 調査内容
振る舞い駆動開発（BDD）の導入により、t-wadaのTDD手法をより効果的に実践する方法を調査。

#### 情報源
- t-wada氏の講演資料「TDDの死」「TDDの復活」
- Eric EvansのDDD書籍の振る舞い記述パターン
- Given-When-Thenパターンのベストプラクティス

#### 重要な発見
1. **ドメインモデルファースト**
   - ビジネスルールをドメインエンティティの振る舞いとして実装
   - 値オブジェクトによる不変性とバリデーション
   - ドメインサービスによる複雑なビジネスロジック

2. **Gherkinによる仕様記述**
   - Given-When-Then形式でユーザーストーリーを記述
   - 実装者とドメインエキスパートの共通言語
   - テストケースとドキュメントの一体化

3. **t-wada TDDサイクル強化**
   - Red: 振る舞いベースの失敗テスト記述
   - Green: ドメインロジック中心の最小実装
   - Refactor: ドメインモデルの洗練

#### 設計への影響
- ドメインエンティティに明確な振る舞いメソッドを定義
- 値オブジェクトでビジネスルール検証を実装
- BDDシナリオをそのままテストケース化

## アーキテクチャ決定事項

### 1. レンダリング戦略
- **決定**: Server Components + 部分的Client Components
- **理由**: 初期表示パフォーマンスとインタラクティビティのバランス
- **詳細**: 静的コンテンツはSSG、動的要素はClient Component

### 2. アニメーションライブラリ
- **決定**: Framer Motion
- **理由**: Next.js統合、高パフォーマンス、豊富なAPI
- **制約**: Client Componentでのみ使用

### 3. スタイリングアプローチ
- **決定**: Tailwind CSS + CSS Modules（アニメーション用）
- **理由**: 開発効率とパフォーマンスの両立
- **考慮事項**: AnimatePresenceとCSS Modulesの相性問題

### 4. コンポーネント設計
- **決定**: Atomic Design原則に基づく階層構造
- **理由**: 再利用性と保守性
- **実装**: atoms/molecules/organisms/templatesの4層構造

### 5. テスト駆動開発戦略
- **決定**: t-wada TDD + BDD振る舞い仕様
- **理由**: ドメインロジックの品質向上、保守性確保
- **実装方針**:
  - ドメイン層：100%テストカバレッジ
  - BDD仕様書とテストコードの同期
  - AAA（Arrange-Act-Assert）パターン厳守

## リスクと緩和策

### 1. パフォーマンスリスク
- **リスク**: アニメーション過多によるパフォーマンス低下
- **緩和策**: 
  - will-changeの適切な使用
  - GPUアクセラレーション活用
  - アニメーション要素の制限

### 2. アクセシビリティリスク
- **リスク**: WCAG非準拠による利用者制限
- **緩和策**:
  - 開発初期からアクセシビリティテスト実施
  - 自動テストツールとマニュアルテストの併用
  - prefers-reduced-motionの考慮

### 3. ブラウザ互換性
- **リスク**: 古いブラウザでの表示崩れ
- **緩和策**:
  - プログレッシブエンハンスメント
  - ポリフィルの選択的使用
  - フォールバック実装

### 5. Next.js エラーハンドリングアーキテクチャ

#### 調査内容
Next.js 16 App Routerにおけるエラーハンドリングベストプラクティスと、アプリケーション初期セットアップとしてのエラーページ実装を調査。

#### 情報源
- Next.js公式ドキュメント（2025年最新版）
- エラーバウンダリとエラー監視のベストプラクティス
- Sentryなどのエラー監視ツール統合パターン

#### 重要な発見
1. **エラーファイルの階層構造**
   - `error.tsx`: セグメント単位のエラーバウンダリ（Client Component必須）
   - `not-found.tsx`: 404エラー処理（デフォルトServer Component）
   - `global-error.tsx`: ルートレイアウトエラー処理（html/bodyタグ必須）

2. **エラーバウンダリの特性**
   - レンダリング時のエラーをキャッチ
   - イベントハンドラー内のエラーはキャッチ不可
   - 親セグメントへのエラーバブリング
   - リセット機能の提供

3. **セキュリティとプライバシー**
   - 本番環境では詳細エラーを隠蔽
   - digestプロパティでサーバーログとの照合
   - 機密情報の保護

4. **エラー監視統合**
   - Sentryなどとの統合パターン
   - 手動エラーキャプチャの実装
   - 環境別（client/server/edge）設定

#### 設計への影響
- アプリケーション初期セットアップとして各レベルのエラーページを実装
- エラーバウンダリの階層的配置でグラニュラーなエラーハンドリング
- リセット機能による一時的エラーからの復旧
- 将来のエラー監視ツール統合を考慮した設計

## 実装の並列化機会

以下のタスクは並列実装が可能：

1. **UIコンポーネント開発**
   - 神社ビジュアル背景
   - おみくじカードコンポーネント
   - レアリティ表示システム

2. **アニメーション実装**
   - カードホバーエフェクト
   - ページ遷移アニメーション
   - レアリティエフェクト

3. **アクセシビリティ対応**
   - キーボードナビゲーション
   - ARIAラベル実装
   - フォーカス管理

4. **エラーハンドリング基盤**
   - error.tsx、not-found.tsx、global-error.tsx の実装
   - カスタムエラータイプの定義
   - エラー監視フックの準備

これらの並列実装により、開発効率を最大化できる。