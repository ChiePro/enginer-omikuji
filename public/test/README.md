# 運勢ランダム化機能 - ブラウザ統合テスト

## 概要
このテストスイートは、運勢ランダム化機能をブラウザ環境で検証するための統合テストツールです。実際のユーザー体験に近い環境で、以下の要件を確認できます。

## テスト内容

### 1. セッションベース重複制御テスト
- 同一セッション内での連続実行時の重複回避動作を検証
- カテゴリコンテンツのバリエーション数を確認
- 要件3.4（同一セッション内で同じカテゴリコンテンツの重複を最小限に抑制）の検証

### 2. 運勢分布検証テスト
- 各運勢の出現確率が期待値に近いかを統計的に検証
- 視覚的なグラフ表示による分布確認
- 誤差率の計算と表示

### 3. パフォーマンステスト
- API応答時間の測定
- 100ms以内の応答率を検証（要件5.1: 100ms以内でのカテゴリ選択処理完了）
- 統計情報の表示（平均値、95パーセンタイル、最小/最大値）

### 4. 感情属性分布検証テスト
- 運勢別の感情属性（positive/neutral/negative）分布を検証
- 大吉は全てpositive、大凶は全てnegativeになるかの確認（要件2.1, 2.2）
- 視覚的なスタックバーチャートによる表示

## 使用方法

### 方法1: Next.js開発サーバーを使用

#### 1. 開発サーバーの起動
```bash
npm run dev
```

#### 2. テストページへのアクセス
ブラウザで以下のURLにアクセス：
```
http://localhost:3000/test/fortune-randomization-test.html
```

### 方法2: スタンドアロンテストサーバーを使用

#### 1. メインアプリの起動
```bash
npm run dev
```

#### 2. テストサーバーの起動（別ターミナル）
```bash
node public/test/test-server.js
```

#### 3. テストページへのアクセス
ブラウザで以下のURLにアクセス：
```
http://localhost:3001/
```

> **注意**: スタンドアロンサーバーは静的ファイルのみ提供します。API呼び出しのためにメインアプリ（ポート3000）が起動している必要があります。

### 3. 各テストの実行
- 各セクションの「実行」ボタンをクリックしてテストを開始
- パラメータ（セッションID、実行回数など）は必要に応じて変更可能
- 結果はリアルタイムで表示され、グラフで視覚化されます

## 技術仕様

### 使用ライブラリ
- Chart.js: グラフ表示用
- Vanilla JavaScript: テストロジック実装

### APIエンドポイント
- `/api/omikuji/draw`: おみくじ抽選API

### テストパラメータ
- `sessionId`: セッション識別子（重複制御テスト用）
- `omikujiType`: おみくじタイプ（5種類から選択可能）
- `saisenLevel`: お賽銭レベル（デフォルト: 2）
- `seed`: 決定論的ランダム化用シード値

## 期待される結果

### パフォーマンス要件
- 95%以上のリクエストが100ms以内に応答すること

### 運勢分布要件
- 各運勢の出現率が期待値から±20%以内であること
- 大吉: 3%、中吉: 15%、吉: 25%、小吉: 30%、末吉: 15%、凶: 10%、大凶: 2%

### 感情属性要件
- 大吉: 100% positive
- 大凶: 100% negative
- その他: 運勢値に応じた分布

## トラブルシューティング

### APIエラーが発生する場合
1. 開発サーバーが起動しているか確認
2. ネットワークタブでAPIレスポンスを確認
3. コンソールログでエラー詳細を確認

### グラフが表示されない場合
1. Chart.js CDNへの接続を確認
2. ブラウザのコンソールでJavaScriptエラーを確認

## 今後の拡張案
- Cypress/Playwrightを使用した自動化テストの追加
- WebSocketを使用したリアルタイム統計表示
- 複数ユーザーでの同時実行シミュレーション